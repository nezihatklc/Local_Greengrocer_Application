<?xml version="1.0" encoding="UTF-8"?>

<!--
 
  Purpose:
  - Base OWNER screen layout.
  - Left side lists products in a TableView (Week11: TableView).
  - Right side will contain the Add/Update form (next step).

  Week11 Concepts Used:
  - fx:controller  -> binds this FXML to the controller class.
  - fx:id          -> binds UI nodes to @FXML fields in the controller.
  - onAction       -> binds button events to controller methods (#handleX).
  - BorderPane     -> region-based layout (top/center).
  - SplitPane      -> splits the screen into two resizable panels.

  Project Rules Reminder (rules.md):
  - Controllers must NOT run SQL.
  - Controllers call Service methods.
  - Business logic is in Service; raw DB work is in DAO.
-->

<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.geometry.Insets?>
<?import javafx.scene.image.ImageView?>
<?import javafx.scene.chart.*?>

<BorderPane xmlns="http://javafx.com/javafx/8"
            xmlns:fx="http://javafx.com/fxml/1"
            fx:controller="com.group18.greengrocer.controller.OwnerController"
            stylesheets="@../css/style.css">

    <!-- TOP: Header bar -->
    <top>
        <HBox spacing="15" styleClass="app-header" alignment="CENTER_LEFT">
            <Label text="Owner Dashboard" styleClass="heading-2" style="-fx-text-fill: white; -fx-font-size: 20px;"/>

            <!-- Spacer: pushes username to the right -->
            <Region HBox.hgrow="ALWAYS"/>

            <!-- Logged-in user info (filled by Controller using SessionManager later) -->
            <Label text="User:" styleClass="text-white"/>
            <Label fx:id="usernameLabel" text="-" styleClass="text-white" style="-fx-font-weight: bold;"/>
            <Button fx:id="backButton" text="Back" onAction="#handleBack" styleClass="button-secondary"/>
            <Button fx:id="logoutButton" text="Logout" onAction="#handleLogout" styleClass="button-danger"/>

        </HBox>
    </top>

    <!-- CENTER: Main content with Tabs -->
    <center>
        <TabPane tabClosingPolicy="UNAVAILABLE" style="-fx-background-color: transparent;">
            
            <!-- TAB 1: Products (Existing Interface) -->
            <Tab text="Products">
                <SplitPane dividerPositions="0.60" style="-fx-background-color: transparent;">

                    <!-- LEFT: Product list (TableView) -->
                    <VBox spacing="15" style="-fx-background-color: #F4F6F8; -fx-padding: 15;">
                        <Label text="All Products (Owner View)" styleClass="heading-2"/>

                        <!--
                          TableView rows will be loaded in OwnerController using ProductService.
                          Columns will be bound to Product fields in the controller (PropertyValueFactory).
                        -->
                        <TableView fx:id="productTable" VBox.vgrow="ALWAYS">
                            <columns>
                                <TableColumn fx:id="idCol" text="ID" prefWidth="60"/>
                                <TableColumn fx:id="nameCol" text="Name" prefWidth="150"/>
                                <TableColumn fx:id="categoryCol" text="Category" prefWidth="110"/>
                                <TableColumn fx:id="typeCol" text="Type" prefWidth="120"/>
                                <TableColumn fx:id="unitCol" text="Unit" prefWidth="70"/>
                                <TableColumn fx:id="priceCol" text="Price" prefWidth="90"/>
                                <TableColumn fx:id="stockCol" text="Stock" prefWidth="90"/>
                                <TableColumn fx:id="thresholdCol" text="Threshold" prefWidth="100"/>
                            </columns>

                        </TableView>

                        <!-- Action buttons -->
                        <HBox spacing="15" alignment="CENTER_LEFT">
                            <!-- Week11: onAction -> calls OwnerController.handleRefresh() -->
                            <Button text="Refresh" onAction="#handleRefresh" styleClass="button-secondary"/>

                            <!-- Week11: onAction -> calls OwnerController.handleDelete() -->
                            <Button text="Delete Selected" onAction="#handleDelete" styleClass="button-danger"/>

                            <Region HBox.hgrow="ALWAYS"/>

                            <!-- Shows the computed effective price (threshold rule) -->
                            <VBox alignment="CENTER_RIGHT"> 
                                <Label text="Effective Price:" styleClass="subtitle"/>
                                <Label fx:id="effectivePriceLabel" text="-" style="-fx-font-weight: bold; -fx-text-fill: #2E7D32;" />
                            </VBox>
                        </HBox>
                    </VBox>

                    <!-- RIGHT: Product Form -->
                    <VBox spacing="15" styleClass="card" style="-fx-padding: 20; -fx-background-color: white;">
                        <Label text="Product Details" styleClass="heading-2"/>
                        
                        <GridPane hgap="10" vgap="15">
                            <padding><Insets top="10" right="10" bottom="10" left="0"/></padding>
                            
                            <Label text="Name:" GridPane.rowIndex="0" GridPane.columnIndex="0" styleClass="label"/>
                            <TextField fx:id="nameField" promptText="e.g. Apple" GridPane.rowIndex="0" GridPane.columnIndex="1"/>
                            
                            <Label text="Category:" GridPane.rowIndex="1" GridPane.columnIndex="0" styleClass="label"/>
                            <ComboBox fx:id="categoryCombo" promptText="Select Category" prefWidth="200" GridPane.rowIndex="1" GridPane.columnIndex="1"/>
                            
                            <Label text="Type:" GridPane.rowIndex="2" GridPane.columnIndex="0" styleClass="label"/>
                            <TextField fx:id="typeField" promptText="e.g. Golden" GridPane.rowIndex="2" GridPane.columnIndex="1"/>
                            
                            <Label text="Unit:" GridPane.rowIndex="3" GridPane.columnIndex="0" styleClass="label"/>
                            <TextField fx:id="unitField" promptText="e.g. kg" GridPane.rowIndex="3" GridPane.columnIndex="1"/>
                            
                            <Label text="Price (â‚º):" GridPane.rowIndex="4" GridPane.columnIndex="0" styleClass="label"/>
                            <TextField fx:id="priceField" promptText="0.00" GridPane.rowIndex="4" GridPane.columnIndex="1"/>
                            
                            <Label text="Stock:" GridPane.rowIndex="5" GridPane.columnIndex="0" styleClass="label"/>
                            <TextField fx:id="stockField" promptText="0.0" GridPane.rowIndex="5" GridPane.columnIndex="1"/>
                            
                            <Label text="Threshold:" GridPane.rowIndex="6" GridPane.columnIndex="0" styleClass="label"/>
                            <TextField fx:id="thresholdField" promptText="Low stock alert level" GridPane.rowIndex="6" GridPane.columnIndex="1"/>

                            <Label text="Image:" GridPane.rowIndex="7" GridPane.columnIndex="0"/>
                            <HBox spacing="10" alignment="CENTER_LEFT" GridPane.rowIndex="7" GridPane.columnIndex="1">
                                <Button text="Upload" onAction="#handleUploadImage"/>
                                <ImageView fx:id="productImageView" fitWidth="40" fitHeight="40" preserveRatio="true" style="-fx-border-color: lightgray;"/>
                            </HBox>
                        </GridPane>

                        <HBox spacing="10" alignment="CENTER_LEFT">
                            <Button text="Add New" fx:id="addButton" onAction="#handleAdd" styleClass="button-primary"/>
                            <Button text="Update" fx:id="updateButton" onAction="#handleUpdate" styleClass="button-secondary"/>
                            <Button text="Clear Form" onAction="#handleClear" styleClass="button-secondary"/>
                        </HBox>

                       <Label text="* Threshold Rule: If Stock &lt;= Threshold, Price is doubled automatically." 
       wrapText="true" style="-fx-text-fill: gray; -fx-font-size: 11px;"/>
                    </VBox>

                </SplitPane>
            </Tab>

            <!-- TAB 2: Carrier Management -->
            <Tab text="Carriers">
                <SplitPane dividerPositions="0.65" style="-fx-background-color: transparent;">
                    
                    <!-- LEFT: Carrier List -->
                    <VBox spacing="15" style="-fx-background-color: #F4F6F8; -fx-padding: 15;">
                        <Label text="Employees (Carriers)" styleClass="heading-2"/>
                        
                        <TableView fx:id="carrierTable" VBox.vgrow="ALWAYS">
                            <columns>
                                <TableColumn fx:id="carrierIdCol" text="ID" prefWidth="50"/>
                                <TableColumn fx:id="carrierNameCol" text="Username" prefWidth="120"/>
                                <TableColumn fx:id="carrierPhoneCol" text="Phone" prefWidth="120"/>
                                <TableColumn fx:id="carrierAddressCol" text="Address" prefWidth="150"/>
                                <!-- Optional: Rating Column if needed later -->
                            </columns>

                        </TableView>

                        <HBox spacing="15">
                            <Button text="Refresh List" onAction="#handleRefreshCarriers" styleClass="button-secondary"/>
                            <Button text="View Ratings" onAction="#handleViewCarrierRatings" styleClass="button-accent"/>
                            <Button text="Fire Selected" onAction="#handleFireCarrier" styleClass="button-danger"/>
                        </HBox>
                    </VBox>

                    <!-- RIGHT: Hire New Carrier Form -->
                    <VBox spacing="15" styleClass="card" style="-fx-padding: 20; -fx-background-color: white;">
                        <Label text="Hire New Carrier" styleClass="heading-2"/>
                        
                        <VBox spacing="5" alignment="CENTER_LEFT">
                            <Label text="Username:" styleClass="label"/>
                            <TextField fx:id="carrierUsernameField" promptText="Login username"/>
                        </VBox>

                        <VBox spacing="5" alignment="CENTER_LEFT">
                            <Label text="Password:" styleClass="label"/>
                            <PasswordField fx:id="carrierPasswordField" promptText="Strong password"/>
                        </VBox>

                        <VBox spacing="5" alignment="CENTER_LEFT">
                            <Label text="Phone:" styleClass="label"/>
                            <TextField fx:id="carrierPhoneField" promptText="10-13 digits"/>
                        </VBox>

                        <VBox spacing="5" alignment="CENTER_LEFT">
                            <Label text="Address:" styleClass="label"/>
                            <TextArea fx:id="carrierAddressArea" prefRowCount="3" wrapText="true" promptText="Full address"/>
                        </VBox>

                        <Button text="Hire (Register)" onAction="#handleHireCarrier" 
                                styleClass="button-primary" maxWidth="Infinity"/>
                        
                        <Label text="* Default role will be CARRIER." style="-fx-text-fill: gray;"/>
                    </VBox>

                </SplitPane>
            </Tab>

            <!-- TAB 3: Orders (Approval) -->
            <Tab text="Orders">
                <SplitPane dividerPositions="0.6">
                    <VBox spacing="10" style="-fx-padding: 10;">
                        <Label text="Incoming Orders (Waiting Approval)" styleClass="heading-2"/>
                        <TableView fx:id="ordersTable" VBox.vgrow="ALWAYS">
                            <columns>
                                <TableColumn fx:id="orderIdCol" text="ID" prefWidth="50"/>
                                <TableColumn fx:id="orderCustomerCol" text="Customer" prefWidth="120"/>
                                <TableColumn fx:id="orderDateCol" text="Date" prefWidth="120"/>
                                <TableColumn fx:id="orderTotalCol" text="Total" prefWidth="80"/>
                                <TableColumn fx:id="orderStatusCol" text="Status" prefWidth="100"/>
                            </columns>
                        </TableView>
                        <Button text="Refresh Orders" onAction="#handleRefreshOrders" styleClass="button-secondary"/>
                    </VBox>
                    <VBox spacing="10" style="-fx-padding: 20;">
                         <Label text="Order Details" styleClass="heading-2"/>
                         <TextArea fx:id="orderDetailsArea" editable="false" wrapText="true" VBox.vgrow="ALWAYS"/>
                         <Button text="Approve Order" onAction="#handleApproveOrder" styleClass="button-primary" maxWidth="Infinity" style="-fx-background-color: #2E7D32; -fx-text-fill: white; -fx-font-weight: bold; -fx-font-size: 14px;"/>
                    </VBox>
                </SplitPane>
            </Tab>

            <!-- TAB 4: Discounts & Loyalty -->
            <Tab text="Discounts">
                <SplitPane dividerPositions="0.5">
                    <!-- LEFT: Create Coupon -->
                    <VBox spacing="10">
                        <padding>
                            <Insets top="10" right="10" bottom="10" left="10"/>
                        </padding>
                        <Label text="Create New Coupon" style="-fx-font-size: 14px; -fx-font-weight: bold;"/>
                        
                        <Label text="Code:"/>
                        <TextField fx:id="couponCodeField" promptText="e.g. SUMMER2026"/>
        
                        <Label text="Discount Amount (TL):"/>
                        <TextField fx:id="couponAmountField" promptText="e.g. 50.0"/>
                        
                        <Label text="Expiry Date:"/>
                        <DatePicker fx:id="couponExpiryPicker" maxWidth="Infinity"/>
                        
                        <Button text="Create Coupon" onAction="#handleCreateCoupon"
                                style="-fx-base: #FF9800; -fx-font-weight: bold;"/>
                    </VBox>

                    <!-- RIGHT: Loyalty Settings -->
                    <VBox spacing="10">
                        <padding>
                            <Insets top="10" right="10" bottom="10" left="10"/>
                        </padding>
                        <Label text="Loyalty Configuration" style="-fx-font-size: 14px; -fx-font-weight: bold;"/>
                        
                        <Label text="Requirement (Min. Orders):"/>
                        <TextField fx:id="loyaltyMinOrderField" promptText="Default: 5"/>
                        
                        <Label text="Discount Rate (%):"/>
                        <TextField fx:id="loyaltyRateField" promptText="Default: 10"/>
                        
                        <Button text="Update Rules" onAction="#handleUpdateLoyalty"
                                style="-fx-base: #2196F3;"/>
                                
                        <Label text="* Loyalty applies to customers who completed enough orders." 
                               wrapText="true" style="-fx-text-fill: gray;"/>
                    </VBox>
                </SplitPane>
            </Tab>


            
            <!-- TAB 4: Reports & Analytics -->
            <Tab text="Reports">
                <ScrollPane fitToWidth="true">
                    <VBox spacing="20" style="-fx-padding: 15; -fx-background-color: #F4F6F8;">
                        <Label text="Business Analytics" styleClass="heading-2"/>

                        <!-- ROW 1: Summary Cards -->
                        <GridPane hgap="15" vgap="15">
                            <columnConstraints>
                                <ColumnConstraints percentWidth="25"/>
                                <ColumnConstraints percentWidth="25"/>
                                <ColumnConstraints percentWidth="25"/>
                                <ColumnConstraints percentWidth="25"/>
                            </columnConstraints>
                            
                            <!-- Card 1: Revenue -->
                            <VBox styleClass="card" style="-fx-background-color: #2E7D32; -fx-padding: 20; -fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.1), 10, 0, 0, 0);" GridPane.columnIndex="0">
                                <Label text="Total Revenue" style="-fx-text-fill: white; -fx-font-size: 14px; -fx-opacity: 0.9;"/>
                                <Label fx:id="totalRevenueLabel" text="0.00 TL" style="-fx-text-fill: white; -fx-font-size: 28px; -fx-font-weight: bold;"/>
                            </VBox>
                            
                            <!-- Card 2: Orders -->
                            <VBox styleClass="card" style="-fx-background-color: #1976D2; -fx-padding: 20; -fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.1), 10, 0, 0, 0);" GridPane.columnIndex="1">
                                 <Label text="Total Orders" style="-fx-text-fill: white; -fx-font-size: 14px; -fx-opacity: 0.9;"/>
                                 <Label fx:id="totalOrdersLabel" text="0" style="-fx-text-fill: white; -fx-font-size: 28px; -fx-font-weight: bold;"/>
                            </VBox>
                            
                            <!-- Card 3: Customers -->
                            <VBox styleClass="card" style="-fx-background-color: #FBC02D; -fx-padding: 20; -fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.1), 10, 0, 0, 0);" GridPane.columnIndex="2">
                                 <Label text="Active Customers" style="-fx-text-fill: white; -fx-font-size: 14px; -fx-opacity: 0.9;"/>
                                 <Label fx:id="activeCustomersLabel" text="0" style="-fx-text-fill: white; -fx-font-size: 28px; -fx-font-weight: bold;"/>
                            </VBox>
                            
                            <!-- Card 4: Avg Order Value -->
                            <VBox styleClass="card" style="-fx-background-color: #7B1FA2; -fx-padding: 20; -fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.1), 10, 0, 0, 0);" GridPane.columnIndex="3">
                                 <Label text="Avg. Order Value" style="-fx-text-fill: white; -fx-font-size: 14px; -fx-opacity: 0.9;"/>
                                 <Label fx:id="avgOrderValueLabel" text="0.00 TL" style="-fx-text-fill: white; -fx-font-size: 28px; -fx-font-weight: bold;"/>
                            </VBox>
                        </GridPane>

                        <!-- ROW 2: Pie Charts (Categories & Status) -->
                        <HBox spacing="15" VBox.vgrow="ALWAYS">
                            <!-- Category Distribution -->
                            <VBox styleClass="card" HBox.hgrow="ALWAYS" style="-fx-background-color: white; -fx-padding: 15;">
                                <Label text="Sales by Category" styleClass="subtitle"/>
                                <PieChart fx:id="categoryPieChart" labelsVisible="false" legendSide="RIGHT"/>
                            </VBox>

                            <!-- Order Status Distribution -->
                            <VBox styleClass="card" HBox.hgrow="ALWAYS" style="-fx-background-color: white; -fx-padding: 15;">
                                <Label text="Order Status Distribution" styleClass="subtitle"/>
                                <PieChart fx:id="orderStatusChart" labelsVisible="false" legendSide="RIGHT"/>
                            </VBox>
                        </HBox>

                        <!-- ROW 3: Bar Chart (Top Products) -->
                        <VBox styleClass="card" VBox.vgrow="ALWAYS" style="-fx-background-color: white; -fx-padding: 15;">
                            <Label text="Top Revenue Products" styleClass="subtitle"/>
                            <BarChart fx:id="productSalesChart" legendVisible="false">
                                <xAxis><CategoryAxis label="Product" /></xAxis>
                                <yAxis><NumberAxis label="Revenue (TL)" /></yAxis>
                            </BarChart>
                        </VBox>

                        <!-- ROW 4: Line Chart (Time) -->
                        <VBox styleClass="card" VBox.vgrow="ALWAYS" style="-fx-background-color: white; -fx-padding: 15;">
                            <Label text="Revenue Trends (Daily)" styleClass="subtitle"/>
                            <LineChart fx:id="revenueChart" legendVisible="false">
                                <xAxis><CategoryAxis label="Date" /></xAxis>
                                <yAxis><NumberAxis label="Total Sales (TL)" /></yAxis>
                            </LineChart>
                        </VBox>
                        
                        <Button text="Refresh Reports" onAction="#handleRefreshReports" styleClass="button-primary"/>
                    </VBox>
                </ScrollPane>
            </Tab>

            <!-- TAB 5: Customer Messages -->
            <Tab text="Messages">
                <SplitPane dividerPositions="0.4">
                    <!-- LEFT: Message List -->
                    <VBox spacing="10" style="-fx-padding: 10; -fx-background-color: #F4F6F8;">
                        <Label text="Inbox" styleClass="heading-2"/>
                        <TableView fx:id="messagesTable" VBox.vgrow="ALWAYS">
                            <columns>
                                <TableColumn fx:id="msgFromCol" text="From" prefWidth="100"/>
                                <TableColumn fx:id="msgDateCol" text="Date" prefWidth="120"/>
                                <TableColumn fx:id="msgContentCol" text="Preview" prefWidth="150"/>
                            </columns>
                        </TableView>
                        <Button text="Refresh Inbox" onAction="#handleRefreshMessages" styleClass="button-secondary"/>
                    </VBox>

                    <!-- RIGHT: Read & Reply -->
                    <VBox spacing="15" style="-fx-padding: 20; -fx-background-color: white;">
                        <Label text="Message Details" styleClass="heading-2"/>
                        
                        <Label text="From:" styleClass="label"/>
                        <TextField fx:id="msgSenderField" editable="false" style="-fx-background-color: #f0f0f0;"/>

                        <Label text="Content:" styleClass="label"/>
                        <TextArea fx:id="msgReadArea" editable="false" wrapText="true" prefRowCount="5" style="-fx-background-color: #f0f0f0;"/>

                        <Separator/>

                        <Label text="Your Reply:" styleClass="label"/>
                        <TextArea fx:id="msgReplyArea" wrapText="true" prefRowCount="4" promptText="Type your reply here..."/>

                        <HBox spacing="10" alignment="CENTER_RIGHT">
                            <Button text="Mark as Read" onAction="#handleMarkAsRead" styleClass="button-secondary"/>
                            <Button text="Send Reply" onAction="#handleSendReply" styleClass="button-primary"/>
                        </HBox>
                    </VBox>
                </SplitPane>
            </Tab>

        </TabPane>
    </center>

</BorderPane>
